<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=240, height=320, user-scalable=no">
    <title>Jio Cloud Apps Browser</title>
    <style>
    * { margin: 0; padding: 0; -moz-box-sizing: border-box; box-sizing: border-box; }
    html, body { width: 240px; height: 320px; overflow: hidden; font-family: Arial, sans-serif; background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%); color: #333; }
    .container { width: 240px; height: 320px; position: relative; }
    .frame { width: 240px; height: 296px; background: #fff; position: relative; overflow: hidden; }
    .frame img { width: 240px; height: 296px; object-fit: fill; }
    .cursor { position: absolute; width: 16px; height: 16px; border: 2px solid #667eea; background: rgba(102, 126, 234, 0.3); border-radius: 50%; margin-left: -8px; margin-top: -8px; pointer-events: none; z-index: 100; box-shadow: 0 0 8px rgba(102, 126, 234, 0.5); }
    .cursor.click { background: rgba(255, 65, 108, 0.5); border-color: #ff416c; }
    .status { width: 240px; height: 24px; background: #fff; padding: 3px 8px; font-size: 8px; color: #666; box-shadow: 0 -2px 8px rgba(0,0,0,0.05); }
    .url { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #333; }
    .controls { font-size: 7px; color: #888; }
    .conn { position: absolute; top: 3px; left: 3px; width: 8px; height: 8px; border-radius: 50%; background: #ff416c; z-index: 150; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .conn.ok { background: #38ef7d; }
    .loading { position: absolute; top: 0; left: 0; width: 240px; height: 296px; background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%); display: -moz-box; display: flex; -moz-box-align: center; align-items: center; -moz-box-pack: center; justify-content: center; z-index: 200; flex-direction: column; }
    .loading.hide { display: none; }
    .spinner { width: 36px; height: 36px; border: 3px solid #e9ecef; border-top-color: #667eea; border-radius: 50%; -moz-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
    .loading-text { margin-top: 12px; font-size: 11px; color: #667eea; font-weight: 500; }
    @-moz-keyframes spin { to { -moz-transform: rotate(360deg); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .debug { position: absolute; top: 3px; right: 3px; font-size: 8px; color: #667eea; background: rgba(255,255,255,0.9); padding: 2px 6px; z-index: 300; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .typing { position: absolute; bottom: 28px; left: 6px; font-size: 10px; color: #fff; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 4px 10px; z-index: 260; display: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
    .typing.show { display: block; }
    /* Hidden input for T9 capture - positioned off-screen but focusable */
    #t9input { position: absolute; left: -9999px; top: 0; width: 1px; height: 1px; opacity: 0; }
    /* Disable KaiOS native spatial navigation indicators */
    *:focus { outline: none !important; -moz-outline: none !important; box-shadow: none !important; }
    html, body, .container, .frame { -moz-user-focus: ignore; }
    img { -moz-user-focus: ignore; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="frame" id="frame">
            <img id="img" src="">
            <div class="cursor" id="cursor"></div>
            <div class="conn" id="conn"></div>
            <div class="debug" id="debug"></div>
        </div>
        <div class="loading" id="loading"><div class="spinner"></div></div>
        <div class="typing" id="typing">TYPING (*=exit)</div>
        <input type="text" id="t9input" autocomplete="off" autocapitalize="off">
        <div class="status">
            <div class="url" id="url">Loading...</div>
            <div class="controls">2468:Move | OK/5:Click | *:Type | 3/9:Scroll | 7:Back | 0:Home</div>
        </div>
    </div>
    <script>
    (function() {
        var server = localStorage.getItem('jiomosa_server') || '';
        var targetUrl = localStorage.getItem('jiomosa_url') || 'https://duckduckgo.com';
        var sessionId = 'kaios_' + Date.now();
        var connected = false;
        var typingMode = false;
        var cursorX = 120, cursorY = 148;
        // Frame image size (server sends 240x320, we display 240x296 with 24px status)
        var frameW = 240, frameH = 320;
        // Display area on KaiOS screen (240x296 visible, 24px for status bar)
        var clientW = 240, clientH = 296;
        var frameTimer = null;
        var clickPending = false;  // Debounce for click

        var img = document.getElementById('img');
        var cursor = document.getElementById('cursor');
        var conn = document.getElementById('conn');
        var debug = document.getElementById('debug');
        var loading = document.getElementById('loading');
        var urlEl = document.getElementById('url');
        var typingEl = document.getElementById('typing');
        var t9input = document.getElementById('t9input');
        var lastT9Value = '';

        function log(m) { debug.textContent = m; }
        function updateCursor() {
            if (cursorX < 0) cursorX = 0;
            if (cursorX > clientW) cursorX = clientW;
            if (cursorY < 0) cursorY = 0;
            if (cursorY > clientH) cursorY = clientH;
            cursor.style.left = cursorX + 'px';
            cursor.style.top = cursorY + 'px';
        }

        function createSession() {
            // First, close any existing session for this device
            var oldSession = localStorage.getItem('jiomosa_session');
            if (oldSession) {
                var closeXhr = new XMLHttpRequest();
                closeXhr.open('POST', server + '/api/session/' + oldSession + '/close', true);
                closeXhr.send();
            }
            
            var xhr = new XMLHttpRequest();
            xhr.timeout = 30000;  // 30 second timeout
            xhr.open('POST', server + '/api/session/create', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200 || xhr.status === 201 || xhr.status === 400) {
                        try {
                            var r = JSON.parse(xhr.responseText);
                            if (r.session_id) {
                                sessionId = r.session_id;
                                localStorage.setItem('jiomosa_session', sessionId);
                            }
                        } catch(e) {}
                        loadUrl();
                    } else {
                        log('Session fail:' + xhr.status);
                        loading.className = 'loading hide';
                    }
                }
            };
            xhr.ontimeout = function() {
                log('Session timeout');
                loading.className = 'loading hide';
            };
            xhr.send(JSON.stringify({ session_id: sessionId }));
        }

        function loadUrl() {
            urlEl.textContent = targetUrl;
            var xhr = new XMLHttpRequest();
            xhr.timeout = 30000;  // 30 second timeout
            xhr.open('POST', server + '/api/session/' + sessionId + '/load', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        connected = true;
                        conn.className = 'conn ok';
                        loading.className = 'loading hide';
                        startFrames();
                    } else {
                        log('Load fail:' + xhr.status);
                        loading.className = 'loading hide';
                    }
                }
            };
            xhr.ontimeout = function() {
                log('Timeout');
                loading.className = 'loading hide';
            };
            xhr.send(JSON.stringify({ url: targetUrl }));
        }

        function startFrames() {
            fetchFrame();
            frameTimer = setInterval(fetchFrame, 150);
        }

        function fetchFrame() {
            if (!connected) return;
            var i = new Image();
            i.onload = function() { img.src = i.src; };
            i.src = server + '/api/session/' + sessionId + '/frame?t=' + Date.now();
        }

        function click() {
            if (!connected) { log('Not connected'); return; }
            // Client displays 240x296, server renders 320x480 but sends 240x296 resized
            // Map from display (240x296) to original render space (320x480)
            var sx = Math.round(cursorX * (320 / clientW));  // 240 -> 320
            var sy = Math.round(cursorY * (480 / clientH));  // 296 -> 480
            log('Clk ' + sx + ',' + sy);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', server + '/api/session/' + sessionId + '/input/click', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var r = JSON.parse(xhr.responseText);
                                        log('OK ' + sx + ',' + sy);
                            // Auto-enter typing mode if clicked on input/textarea
                            if (r.element === 'INPUT' || r.element === 'TEXTAREA') {
                                if (!typingMode) toggleTypingMode();
                            }
                        } catch(e) {
                            log('OK ' + sx + ',' + sy);
                        }
                    } else {
                        log('Err:' + xhr.status);
                    }
                }
            };
            xhr.send(JSON.stringify({ x: sx, y: sy }));
            setTimeout(fetchFrame, 300);
        }

        function scroll(dy) {
            if (!connected) { log('Not connected'); return; }
            log('Scroll ' + dy);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', server + '/api/session/' + sessionId + '/input/scroll', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    log('Scroll resp: ' + xhr.status);
                }
            };
            xhr.send(JSON.stringify({ deltaX: 0, deltaY: dy }));
            setTimeout(fetchFrame, 150);
        }

        function zoom(factor) {
            if (!connected) return;
            // Calculate new zoom level
            var newZoom = factor > 1 ? '+0.3' : '-0.3';
            var script = 'var z = parseFloat(document.body.style.zoom || 1); z = Math.max(0.5, Math.min(4, z ' + newZoom + ')); document.body.style.zoom = z.toFixed(1); z.toFixed(1)';
            log('Zoom');
            var xhr = new XMLHttpRequest();
            xhr.open('POST', server + '/api/session/' + sessionId + '/execute', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    try {
                        var r = JSON.parse(xhr.responseText);
                        if (r.result) log('Zoom: ' + r.result + 'x');
                    } catch(e) {}
                }
            };
            xhr.send(JSON.stringify({ script: script }));
            setTimeout(fetchFrame, 200);
        }

        function playPauseVideo() {
            if (!connected) return;
            log('Play/Pause');
            var xhr = new XMLHttpRequest();
            xhr.open('POST', server + '/api/session/' + sessionId + '/execute', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            // Try multiple methods to play/pause video
            var script = 'var v = document.querySelector("video"); if(v) { if(v.paused) v.play(); else v.pause(); "video" } else { var btn = document.querySelector(".ytp-play-button, [aria-label*=Play], [aria-label*=Pause], button[data-title-no-tooltip=Play], button[data-title-no-tooltip=Pause]"); if(btn) { btn.click(); "button" } else { document.dispatchEvent(new KeyboardEvent("keydown", {key: "k", keyCode: 75})); "key" } }';
            xhr.send(JSON.stringify({ script: script }));
            setTimeout(fetchFrame, 300);
        }

        function sendText(text) {
            if (!connected || !text) return;
            log('Send: ' + text);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', server + '/api/session/' + sessionId + '/input/text', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({ text: text }));
            setTimeout(fetchFrame, 300);
        }

        function sendKey(key) {
            if (!connected) return;
            log('Key: ' + key);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', server + '/api/session/' + sessionId + '/input/key', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({ key: key }));
            setTimeout(fetchFrame, 200);
        }

        function goBack() {
            if (!connected) return;
            log('Back');
            var xhr = new XMLHttpRequest();
            xhr.open('POST', server + '/api/session/' + sessionId + '/execute', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({ script: 'window.history.back()' }));
            setTimeout(fetchFrame, 500);
        }

        function goHome() {
            if (frameTimer) clearInterval(frameTimer);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', server + '/api/session/' + sessionId + '/close', true);
            xhr.send();
            window.location.href = 'launcher.html';
        }

        function toggleTypingMode() {
            typingMode = !typingMode;
            typingEl.className = typingMode ? 'typing show' : 'typing';
            if (typingMode) {
                t9input.value = '';
                lastT9Value = '';
                sentLength = 0;
                if (t9Timer) clearTimeout(t9Timer);
                t9input.focus();
                log('TYPING');
            } else {
                // Send any pending characters before exiting
                if (t9Timer) {
                    clearTimeout(t9Timer);
                    sendPendingT9();
                }
                t9input.blur();
                log('NAV');
            }
        }

        // T9 input handling with debounce
        // Wait for user to stop typing before sending the character
        var t9Timer = null;
        var pendingText = '';
        var sentLength = 0;  // Track how many characters we've sent to remote

        function sendPendingT9() {
            var currentVal = t9input.value;
            // Send any new characters since last send
            if (currentVal.length > sentLength) {
                var newChars = currentVal.substring(sentLength);
                log('>' + newChars);
                sendText(newChars);
                sentLength = currentVal.length;
                setTimeout(fetchFrame, 150);
            }
        }

        // Monitor T9 input field for changes
        t9input.addEventListener('input', function() {
            var newVal = t9input.value;
            
            // If a character was deleted
            if (newVal.length < lastT9Value.length) {
                // User deleted - we need to sync with remote
                var deleted = lastT9Value.length - newVal.length;
                for (var i = 0; i < deleted; i++) {
                    sendKey('Backspace');
                }
                sentLength = newVal.length;
                lastT9Value = newVal;
                setTimeout(fetchFrame, 150);
                return;
            }
            
            // If a character was replaced (T9 cycling like j->k->l)
            if (newVal.length === lastT9Value.length && newVal !== lastT9Value) {
                // Character cycling - cancel pending send and wait
                if (t9Timer) clearTimeout(t9Timer);
                log('~' + newVal.charAt(newVal.length - 1));
                lastT9Value = newVal;
                // Wait 800ms for T9 cycling to settle, then send correction
                t9Timer = setTimeout(function() {
                    // Need to backspace the old char and send new one
                    if (sentLength >= newVal.length) {
                        sendKey('Backspace');
                        setTimeout(function() {
                            sendText(newVal.charAt(newVal.length - 1));
                            fetchFrame();
                        }, 100);
                    } else {
                        sendPendingT9();
                    }
                }, 800);
                return;
            }
            
            // New character added
            if (newVal.length > lastT9Value.length) {
                lastT9Value = newVal;
                // Cancel any pending send
                if (t9Timer) clearTimeout(t9Timer);
                // Wait 800ms for T9 multi-tap to settle before sending
                log(':' + newVal.charAt(newVal.length - 1));
                t9Timer = setTimeout(sendPendingT9, 800);
            }
        });

        updateCursor();
        if (server) createSession();
        else log('No server');

        // Handle keydown for special keys only
        document.addEventListener('keydown', function(e) {
            var k = e.key || '';
            var c = e.keyCode || 0;

            // In typing mode, only handle special keys
            if (typingMode) {
                // Exit typing mode with *
                if (k === '*' || c === 42) {
                    // Send any pending T9 characters first
                    if (t9Timer) {
                        clearTimeout(t9Timer);
                        sendPendingT9();
                    }
                    toggleTypingMode();
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
                // Send Enter to remote browser (submits search forms)
                if (k === 'Enter' || c === 13) {
                    log('ENTER');
                    // Send any pending T9 characters first
                    if (t9Timer) {
                        clearTimeout(t9Timer);
                        sendPendingT9();
                    }
                    setTimeout(function() {
                        sendKey('Enter');
                    }, 150);
                    t9input.value = '';
                    lastT9Value = '';
                    sentLength = 0;
                    toggleTypingMode();  // Exit typing mode after submit
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
                // # key also submits (alternative search trigger)
                if (k === '#' || c === 35 || c === 163) {
                    log('SEARCH');
                    // Send any pending T9 characters first
                    if (t9Timer) {
                        clearTimeout(t9Timer);
                        sendPendingT9();
                    }
                    setTimeout(function() {
                        sendKey('Enter');
                    }, 150);
                    t9input.value = '';
                    lastT9Value = '';
                    sentLength = 0;
                    toggleTypingMode();
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
                // Let backspace work on T9 input, but also send to remote
                if (k === 'Backspace' || c === 8) {
                    if (t9input.value.length === 0) {
                        // Input is empty, send backspace to remote
                        sendKey('Backspace');
                        e.preventDefault();
                    }
                    // Otherwise let the input handle it naturally
                    return;
                }
                // Arrow keys / D-pad in typing mode - navigate dropdown suggestions
                // Use 2 for up, 8 for down (or arrow keys)
                if (k === 'ArrowUp' || c === 38) {
                    sendKey('ArrowUp');
                    e.preventDefault();
                    e.stopPropagation();
                    setTimeout(fetchFrame, 150);
                    return false;
                }
                if (k === 'ArrowDown' || c === 40) {
                    sendKey('ArrowDown');
                    e.preventDefault();
                    e.stopPropagation();
                    setTimeout(fetchFrame, 150);
                    return false;
                }
                // Let all other keys go to the T9 input
                return;
            }

            log('K:' + k + ' C:' + c);
            var step = 20;

            // Navigation with number keys
            if (k === '2' || k === 'ArrowUp' || c === 38) { cursorY -= step; updateCursor(); e.preventDefault(); return; }
            if (k === '8' || k === 'ArrowDown' || c === 40) { cursorY += step; updateCursor(); e.preventDefault(); return; }
            if (k === '4' || k === 'ArrowLeft' || c === 37) { cursorX -= step; updateCursor(); e.preventDefault(); return; }
            if (k === '6' || k === 'ArrowRight' || c === 39) { cursorX += step; updateCursor(); e.preventDefault(); return; }

            // Click - D-pad center / Enter / MicrophoneToggle (keyCode 0 on KaiOS)
            // Use debounce to prevent key repeat causing infinite clicks
            if (k === 'Enter' || k === 'MicrophoneToggle' || c === 13 || (c === 0 && k !== '')) {
                if (!clickPending) {
                    clickPending = true;
                    log('CLICK!');
                    click();
                    setTimeout(function() { clickPending = false; }, 500);
                }
                e.preventDefault();
                return;
            }

            // Click/Select with 5 (alternative to OK button)
            if (k === '5') {
                if (!clickPending) {
                    clickPending = true;
                    log('SELECT!');
                    click();
                    setTimeout(function() { clickPending = false; }, 500);
                }
                e.preventDefault();
                e.stopPropagation();
                return false;
            }

            // Typing mode toggle with *
            if (k === '*' || c === 42) { toggleTypingMode(); e.preventDefault(); return; }

            // Scroll: 3=PageUp (scroll up), 9=PageDown (scroll down)
            // keyCode 51 = '3', keyCode 57 = '9'
            if (k === '3' || c === 51) { 
                log('ScrollUp'); 
                scroll(-150); 
                e.preventDefault(); 
                e.stopPropagation();
                return false; 
            }
            if (k === '9' || c === 57) { 
                log('ScrollDown'); 
                scroll(150); 
                e.preventDefault(); 
                e.stopPropagation();
                return false; 
            }

            // Back with 7, Backspace, EndCall, or Escape key
            // EndCall key on KaiOS is typically Backspace (keyCode 8) or EndCall
            if (k === '7' || k === 'Backspace' || k === 'EndCall' || k === 'BrowserBack' || c === 8 || c === 27) {
                goBack();
                e.preventDefault();
                e.stopPropagation();
                return false;
            }

            // Home with 0
            if (k === '0') { goHome(); e.preventDefault(); return; }

        }, true);

    })();
    </script>
</body>
</html>