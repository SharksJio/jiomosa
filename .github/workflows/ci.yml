name: Jiomosa CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build renderer image
        run: |
          cd renderer
          docker build -t jiomosa-renderer:test .
      
      - name: Start services
        run: |
          docker compose up -d
          echo "Waiting for services to be ready..."
          sleep 30
      
      - name: Check service health
        run: |
          echo "Checking renderer service..."
          curl -f http://localhost:5000/health || exit 1
          
          echo "Checking Selenium..."
          curl -f http://localhost:4444/status || exit 1
          
          echo "All services are healthy!"
      
      - name: Run integration tests
        run: |
          # Install test dependencies
          pip install requests pytest
          
          # Run tests
          python tests/test_renderer.py
      
      - name: Test website rendering
        run: |
          echo "Testing website rendering..."
          
          # Create a session
          SESSION_RESPONSE=$(curl -s -X POST http://localhost:5000/api/session/create \
            -H "Content-Type: application/json" \
            -d '{"session_id": "test_session"}')
          echo "Session created: $SESSION_RESPONSE"
          
          # Load a lightweight website
          LOAD_RESPONSE=$(curl -s -X POST http://localhost:5000/api/session/test_session/load \
            -H "Content-Type: application/json" \
            -d '{"url": "https://example.com"}')
          echo "Website loaded: $LOAD_RESPONSE"
          
          # Get session info
          INFO_RESPONSE=$(curl -s http://localhost:5000/api/session/test_session/info)
          echo "Session info: $INFO_RESPONSE"
          
          # Verify the response contains expected data
          if echo "$INFO_RESPONSE" | grep -q "example.com"; then
            echo "✓ Website rendering test passed!"
          else
            echo "✗ Website rendering test failed!"
            exit 1
          fi
          
          # Close session
          curl -s -X POST http://localhost:5000/api/session/test_session/close
      
      - name: Test multiple website scenarios
        run: |
          bash tests/test_websites.sh
      
      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Renderer logs ==="
          docker compose logs renderer
          echo "=== Chrome logs ==="
          docker compose logs chrome
          echo "=== Android WebApp logs ==="
          docker compose logs android-webapp
      
      - name: Stop services
        if: always()
        run: |
          docker compose down -v
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            tests/*.log
            tests/screenshots/*.png
          retention-days: 7

  deploy-test-environment:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to test environment
        run: |
          echo "Deploying Jiomosa to test environment..."
          echo "This would deploy to your cloud infrastructure"
          echo "For now, we'll just validate the compose file"
          docker compose config
      
      - name: Deployment summary
        run: |
          echo "✓ Deployment validation complete"
          echo "Services configured:"
          echo "  - Renderer API (WebSocket): http://localhost:5000"
          echo "  - Android WebApp: http://localhost:9000"
          echo "  - Selenium Grid: http://localhost:4444"
          echo "  - noVNC (optional): http://localhost:7900"
