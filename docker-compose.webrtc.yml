services:
  # Coturn TURN server for NAT traversal (required for Docker on Windows)
  turn-server:
    image: coturn/coturn:latest
    container_name: jiomosa-turn-server
    restart: unless-stopped
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "49152-49200:49152-49200/udp"
    networks:
      - jiomosa-webrtc-network
    command: >
      -n
      --log-file=stdout
      --min-port=49152
      --max-port=49200
      --realm=jiomosa.local
      --fingerprint
      --lt-cred-mech
      --user=jiomosa:jiomosapass
      --listening-ip=0.0.0.0
      --external-ip=127.0.0.1
      --no-multicast-peers
      --no-cli
      --verbose

  # WebRTC Renderer - Modern FastAPI + aiortc streaming server
  webrtc-renderer:
    build:
      context: ./webrtc_renderer
      dockerfile: Dockerfile
    container_name: jiomosa-webrtc-renderer
    restart: unless-stopped
    environment:
      - DEBUG=false
      - WEBRTC_VIDEO_WIDTH=720
      - WEBRTC_VIDEO_HEIGHT=1280
      - WEBRTC_FRAMERATE=30
      - WEBRTC_DEFAULT_BITRATE=1500000
      - BROWSER_MAX_SESSIONS=10
      - SESSION_CLEANUP_INTERVAL=60
      # Audio configuration
      - AUDIO_ENABLED=true
      - AUDIO_SAMPLE_RATE=48000
      - AUDIO_CHANNELS=2
      # Hardware acceleration flags for Chromium
      - CHROMIUM_FLAGS=--enable-accelerated-video-decode --enable-gpu-rasterization --use-gl=egl
      # Announce 127.0.0.1 so browser can connect to Docker-mapped ports
      - ANNOUNCED_IP=127.0.0.1
    ports:
      - "8000:8000"
      # UDP ports for WebRTC media (ICE candidates)
      - "10000-10100:10000-10100/udp"
    networks:
      - jiomosa-webrtc-network
    volumes:
      - ./webrtc_renderer:/app
    # Required for PulseAudio to work in container
    tmpfs:
      - /run/user/1000:mode=700,uid=1000,gid=1000
    # GPU acceleration: Use docker-compose.webrtc.linux.yml override on Linux
    # Example: docker compose -f docker-compose.webrtc.yml -f docker-compose.webrtc.linux.yml up -d
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # WebRTC WebApp - Modern Material Design PWA for Android
  webrtc-webapp:
    build:
      context: ./webrtc_webapp
      dockerfile: Dockerfile
    container_name: jiomosa-webrtc-webapp
    restart: unless-stopped
    environment:
      - WEBRTC_SERVER=http://webrtc-renderer:8000
    ports:
      - "9000:9000"
    depends_on:
      - webrtc-renderer
    networks:
      - jiomosa-webrtc-network
    volumes:
      - ./webrtc_webapp:/app
      - webapp-data:/app/data

  # Optional: TURN server for NAT traversal (coturn)
  # Uncomment if you need TURN support for production deployment
  # turn-server:
  #   image: coturn/coturn:latest
  #   container_name: jiomosa-turn-server
  #   restart: unless-stopped
  #   ports:
  #     - "3478:3478/tcp"
  #     - "3478:3478/udp"
  #     - "5349:5349/tcp"
  #     - "5349:5349/udp"
  #     - "49152-65535:49152-65535/udp"
  #   environment:
  #     - EXTERNAL_IP=YOUR_PUBLIC_IP
  #     - REALM=jiomosa.local
  #     - USERNAME=jiomosa
  #     - PASSWORD=changeme
  #   networks:
  #     - jiomosa-webrtc-network
  #   volumes:
  #     - ./turnserver.conf:/etc/coturn/turnserver.conf

  # Optional: Redis for distributed session management
  # Uncomment for multi-server deployments
  # redis:
  #   image: redis:7-alpine
  #   container_name: jiomosa-redis
  #   restart: unless-stopped
  #   ports:
  #     - "6379:6379"
  #   networks:
  #     - jiomosa-webrtc-network
  #   volumes:
  #     - redis-data:/data

networks:
  jiomosa-webrtc-network:
    driver: bridge

volumes:
  webapp-data:

# volumes:
#   redis-data:
